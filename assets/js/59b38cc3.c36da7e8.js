"use strict";(self.webpackChunkskip_docs=self.webpackChunkskip_docs||[]).push([[3669],{66345:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var r=t(74848),i=t(28453);const s={},o="Autentisering mot GCP fra applikasjon",a={id:"kubernetes/autentisering-mot-gcp-fra-applikasjon",title:"Autentisering mot GCP fra applikasjon",description:"1. Opprett Servicekonto",source:"@site/docs/06-kubernetes/05-autentisering-mot-gcp-fra-applikasjon.md",sourceDirName:"06-kubernetes",slug:"/kubernetes/autentisering-mot-gcp-fra-applikasjon",permalink:"/docs/kubernetes/autentisering-mot-gcp-fra-applikasjon",draft:!1,unlisted:!1,editUrl:"https://github.com/kartverket/skip-docs/edit/main/docs/06-kubernetes/05-autentisering-mot-gcp-fra-applikasjon.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Bruk av porter i pods",permalink:"/docs/kubernetes/bruk-av-porter-i-pods"},next:{title:"Helsesjekker i Kubernetes",permalink:"/docs/kubernetes/helsesjekker-i-kubernetes"}},c={},l=[{value:"1. Opprett Servicekonto",id:"1-opprett-servicekonto",level:2},{value:"2. Gi WIF IAM Policy til Servicekonto",id:"2-gi-wif-iam-policy-til-servicekonto",level:2},{value:"3. Legg inn config i Skiperatormanifest",id:"3-legg-inn-config-i-skiperatormanifest",level:2},{value:"Alternativ til 1 / 2",id:"alternativ-til-1--2",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"autentisering-mot-gcp-fra-applikasjon",children:"Autentisering mot GCP fra applikasjon"}),"\n",(0,r.jsx)(n.h2,{id:"1-opprett-servicekonto",children:"1. Opprett Servicekonto"}),"\n",(0,r.jsx)(n.p,{children:"Dersom man \xf8nsker \xe5 f\xe5 tilgang til GCP-tjenester fra Kubernetes gj\xf8res dette med \xe5 f\xf8rst opprette en servicekonto i GCP og \xe5 gi den IAM-rettigheter til det man \xf8nsker at den skal gj\xf8re."}),"\n",(0,r.jsxs)(n.p,{children:["Servicekontoer b\xf8r enten opprettes med terraform eller via ",(0,r.jsx)(n.a,{href:"https://github.com/kartverket/gcp-service-accounts",children:"gcp-service-accounts"})," repoet til SKIP."]}),"\n",(0,r.jsx)(n.h2,{id:"2-gi-wif-iam-policy-til-servicekonto",children:"2. Gi WIF IAM Policy til Servicekonto"}),"\n",(0,r.jsxs)(n.p,{children:["To authenticate this service account in GCP from Kubernetes, the service account in Kubernetes needs to be given permission to impersonate the GCP service account. This is done by giving the Kubernetes Service Account the role ",(0,r.jsx)(n.code,{children:"iam.workloadIdentityUser"})," through a so called Workload Identity Pool."]}),"\n",(0,r.jsx)(n.p,{children:"Given the following variables:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"GCP_SA_NAME - Name of the GCP service account\nGCP_SA_PROJECT_ID - GCP Project ID where the service account resides\nKUBERNETES_PROJECT_ID - GCP Project ID for the Kubernetes cluster (for example kubernetes-dev-94b9 for dev-cluster)\nKUBERNETES_NAMESPACE - The Kubernetes namespace where the Pod will run\nKUBERNETES_SA_NAME - The Kubernetes service account name that your Pod is using (typically same name as Application, and with the -skipjob suffix for SKIPJobs)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Run the following command using the ",(0,r.jsx)(n.code,{children:"gcloud"})," CLI:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'gcloud iam service-accounts add-iam-policy-binding \\\n  GCP_SA_NAME@GCP_SA_PROJECT_ID.iam.gserviceaccount.com \\\n  --role=roles/iam.workloadIdentityUser \\\n  --member="serviceAccount:KUBERNETES_PROJECT_ID.svc.id.goog[KUBERNETES_NAMESPACE/KUBERNETES_SA_NAME]"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"3-legg-inn-config-i-skiperatormanifest",children:"3. Legg inn config i Skiperatormanifest"}),"\n",(0,r.jsxs)(n.p,{children:["Til slutt legger man til ",(0,r.jsx)(n.code,{children:"gcp"})," config i sin skiperator Application for \xe5 lage kubernetes-config slik at podden kan autentisere mot GCP."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"//yaml format\nspec:\n  gcp:\n    auth:\n      serviceAccount: GCP_SA_NAME@GCP_SA_PROJECT_ID.iam.gserviceaccount.com\n"})}),"\n",(0,r.jsxs)(n.p,{children:["N\xe5 kan man f\xf8lge \u201cAuthenticate from your code\u201d under ",(0,r.jsx)(n.a,{href:"https://cloud.google.com/anthos/fleet-management/docs/use-workload-identity#-python",children:"https://cloud.google.com/anthos/fleet-management/docs/use-workload-identity#-python"})," for \xe5 autentisere mot GCP fra koden sin."]}),"\n",(0,r.jsx)(n.p,{children:"N\xe5r dette er gjort kan applikasjonen snakke med GCP under runtime."}),"\n",(0,r.jsx)(n.h2,{id:"alternativ-til-1--2",children:"Alternativ til 1 / 2"}),"\n",(0,r.jsx)(n.p,{children:"Dersom man ikke \xf8nsker \xe5 legge til roller manuelt har SKIP lagt til en ny m\xe5te \xe5 legge til Workload Identity User p\xe5 en service account, ved hjelp av Crossplane."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: 'skip.kartverket.no/v1alpha1'\nkind: 'WorkloadIdentityInstance'\nmetadata:\n  name: 'service-account-wi'\nspec:\n  parameters:\n    gcpKubernetesProject: 'some-kubernetes-project' #eks: 'kubernetes-dev-94b9'\n    gcpProject: 'gcp-project-where-service-account-is' #eks: 'dsa-dev-e32c'\n    gcpServiceAccount: 'name-of-service-account-in-gcp' #eks: 'dsa-runtime@dsa-dev-e32c.iam.gserviceaccount.com'\n    serviceAccount: 'name-of-service-account-in-kubernetes' #eks 'dsa-backend', typically same name as your Application\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Se ",(0,r.jsx)(n.a,{href:"/docs/argo-cd/provisjonere-infrastruktur-med-crossplane",children:"Provisjonere infrastruktur med Crossplane"})," om du ikke har brukt Crossplane tidligere."]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var r=t(96540);const i={},s=r.createContext(i);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);