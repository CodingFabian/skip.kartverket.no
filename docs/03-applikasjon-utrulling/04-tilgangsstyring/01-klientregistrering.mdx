import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# üìù Klientregistrering

Klientregistrering er en sentral del av tilgangsstyring med OAuth 2.0 og OIDC. N√•r du registrerer en klient, f√•r applikasjonen sin egen identitet og kan autentisere seg mot de valgte identitetstilbyderne.

Vi anbefaler √• ha et bevisst forhold til hvilke tjenester som skal dele samme `audience`.
Det er ofte mer hensiktsmessig √• velge en restriktiv tiln√¶rming, der hver tjeneste f√•r sin egen klientregistrering, fremfor √• gruppere flere tjenester under √©n felles klient. Dette gir bedre kontroll over tilgangsstyring og sikkerhet.

Felles for alle identitetstilbydere p√• SKIP er at klientregistrering st√∏ttes fra plattformen ved hjelp av Kubernetes-operatorer.

- [**Digdirator**](https://github.com/nais/digdirator) h√•ndterer klientregistrering mot Digdir sine fellesl√∏sninger, nemlig **ID-porten** og **Maskinporten**.
- [**Azurerator**](https://github.com/nais/azurerator) tar seg av klientregistrering mot **Microsoft Entra ID** (tidligere kjent som Azure Active Directory).



<Tabs>
    <TabItem value="skiperator" label="Skiperator">

        CRD-en `Application` definert i Skiperator tilbyr et forenklet API for √• registrere klienter mot **ID-porten** og **Maskinporten**.
        Vi jobber ogs√• med √• innf√∏re tilsvarende funksjonalitet for **Entra ID**, men det er ikke helt klart enn√•.

        <Tabs>
            <TabItem value="entraid" label="Entra ID">
                ## üöß Under utvikling üöß

                Automatisert klientregistrering mot Entra ID i SKiperator application-manifestet er for tiden under utvikling og er ikke helt klart enn√•.
                Vi jobber hardt for √• gj√∏re det tilgjengelig, og vi gleder oss til √• vise deg hvordan du kan ta den i bruk s√• snart vi er klare!
                F√∏lg med for oppdateringer.
            </TabItem>
            <TabItem value="idporten" label="ID-porten">
                [Skiperator](../03-skiperator/04-api-docs.md) tilbyr st√∏tte for √• sette opp en klientintegrasjon mot ID-porten
                via spesifikasjonen til `Application`. F√∏lgende eksempel konfigurerer en integrasjon av typen `api_klient`,
                setter **redirect path** til `/oauth/callback` og spesifiserer scopes `openid` og `profile`. Resten av feltene som st√∏ttes
                kan du finne i Skiperator sin [API-dokumentasjon](../03-skiperator/04-api-docs.md).
```yaml
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: application
  namespace: tilgangsstyring-main
spec:
  image: image
  port: 8080
  idporten:
    enabled: true
    integrationType: "api_klient"
    redirectPath: "/oauth/callback"
    scopes:
      - "openid"
      - "profile"
```
                Fordelen med denne metoden er at Skiperator automatisk injiserer hemmelighetene som Digdirator oppretter
                som milj√∏variabler i deploymenten til `application`. Dette gj√∏r at applikasjonen enkelt kan f√• tilgang til
                hemmelighetene under kj√∏ring.
            </TabItem>
            <TabItem value="maskinporten" label="Maskinporten">
                [Skiperator](../03-skiperator/04-api-docs.md) tilbyr st√∏tte for √• sette opp en klientintegrasjon mot Maskinporten
                via spesifikasjonen til `Application`. F√∏lgende eksempel demonstrerer en minimal konfigurasjon for √• registrere en klient i Maskinporten.
                Resten av feltene som st√∏ttes kan du finne i Skiperator sin [API-dokumentasjon](../03-skiperator/04-api-docs.md).

```yaml
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: application
  namespace: tilgangsstyring-main
spec:
  image: image
  port: 8080
  maskinporten:
    enabled: true
```

                Fordelen med denne metoden er at Skiperator automatisk injiserer hemmelighetene som Digdirator oppretter
                som milj√∏variabler i deploymenten til `application`. Dette gj√∏r at applikasjonen enkelt kan f√• tilgang til
                hemmelighetene under kj√∏ring.
            </TabItem>
        </Tabs>
    </TabItem>
    <TabItem value="native" label="Digdirator / Azurerator">

        Man kan benytte seg direkte av CRD-ene (Custom Resource Definitions) som Digdirator og Azurerator introduserer for √• registrere klienter mot ID-porten, Maskinporten og Entra ID.
        Fordelen med denne tiln√¶rmingen er at man f√•r full kontroll over konfigurasjonen og stor fleksibilitet ved √• frikoble registreringen fra applikasjonen.
        Ulempen er at det krever mer innsikt i oppsettet, og at injisering av hemmeligheter i deploymenten m√• h√•ndteres separat.

        Digdirator introduserer CRD-ene `IdportenClient` og `MaskinportenClient`, som definerer konfigurasjonen for registrering av klienter mot henholdsvis **ID-porten** og **Maskinporten**.
        Azurerator introduserer CRD-en `AzureAdApplication`, som brukes til √• registrere klienter mot **Microsoft Entra ID**.

        Alle tre CRD-ene fungerer p√• samme m√•te: De overv√•kes av sine respektive Kubernetes-operat√∏rer, som benytter konfigurasjonen til √• registrere en klient mot den aktuelle identitetstilbyderen.
        Etter registreringen opprettes en Kubernetes-hemmelighet som inneholder n√∏dvendige hemmeligheter og relevante URI-er. Disse brukes b√•de til token-validering og for √• gjennomf√∏re ulike OAuth 2.0-flows.

        <Tabs>
            <TabItem value="azurerator" label="AzureAdApplication">
                App-registreringer opprettet med Azureator f√∏lger f√∏lgende navnekonvensjon basert p√• `AzureAdApplication`-manifestet: `cluster:namespace:name`.

                ### Spesifikasjonen til `AzureAdApplication`

                <details>
                    <summary><strong>spec</strong> _(required)_ ‚Äì Spesifikasjon for `AzureAdApplication</summary>

                    <p><strong>allowAllUsers</strong> _(bool, required)_ ‚Äì Bestemmer om alle brukere i tenanten som Azurerator er konfigurert mot skal f√• tilgang.</p>

                    <details>
                        <summary><strong>claims</strong> _(object, optional)_ ‚Äì Definerer konfigurasjon av claims som inkluderes i tokenene som returneres til Entra ID applikasjonen.</summary>
                        <details>
                            <summary><strong>groups</strong> _([]object, optional)_ ‚Äì En liste over Entra ID gruppe ID-er som skal inkluderes i `groups-claimet i tokenene utstedt av Entra ID. Dette tildeler ogs√• grupper til app-registreringen brukt for tilgangskontroll. Kun direkte medlemmer av gruppene f√•r tilgang.</summary>
                            <p><strong>id</strong> _(string, required)_ ‚Äì Objekt-ID-en (OID) til en Entra ID-gruppe.</p>
                        </details>
                    </details>

                    <details>
                        <summary><strong>replyUrls</strong> _([]object, required)_ ‚Äì URL-er som applikasjonen godtar som svaradresser etter autentisering.</summary>
                        <p><strong>url</strong> _(string, required)_ ‚Äì En godkjent svaradresse (reply URL) for applikasjonen.</p>
                    </details>

                    <p><strong>logoutUrl</strong> _(string, optional)_ ‚Äì URL-en brukere blir omdirigert til n√•r de logger ut av applikasjonen..</p>

                    <details>
                        <summary><strong>preAuthorizedApplications</strong> _([]object, optional)_ ‚Äì Definerer andre app-registreringer som er forh√•ndsautorisert til √• f√• tilgang til denne applikasjonen. Her refereres det til tilsvarende `AzureAdApplication`.</summary>
                        <p><strong>application</strong> _(string, required)_ ‚Äì Navnet p√• den forh√•ndsgodkjente applikasjonen.</p>
                        <p><strong>namespace</strong> _(string, required)_ ‚Äì Namespacet hvor den forh√•ndsgodkjente applikasjonen befinner seg.</p>
                        <p><strong>cluster</strong> _(string, required)_ ‚Äì Clusteret hvor den forh√•ndsgodkjente applikasjonen befinner seg.</p>
                        <details>
                            <summary><strong>permissions</strong> _(object, optional)_ ‚Äì Spesifiserer hvilke claims den forh√•ndsautoriserte applikasjonen har.</summary>
                            <p><strong>scopes</strong> _([]string, optional)_ ‚Äì Liste med egendefinerte tilgangs-scopes tildelt til den forh√•ndsautoriserte appliaksjonen.</p>
                            <p><strong>roles</strong> _([]string, optional)_ ‚Äì Liste med egendefinerte tilgangs-roller tildelt til den forh√•ndsautoriserte appliaksjonen.</p>
                        </details>
                    </details>

                    <p><strong>secretName</strong> _(string, required)_ ‚Äì Navnet p√• Kubernetes-hemmeligheten der hemmeligheter og annen informasjon for Entra ID applikasjonen lagres.</p>
                    <p><strong>secretKeyPrefix</strong> _(string, optional)_ ‚Äì Et valgfritt brukerdefinert prefiks som brukes p√• n√∏klene i den genererte hemmeligheten, og erstatter standardprefikset (AZURE).</p>
                    <p><strong>secretProtected</strong> _(bool, optional)_ ‚Äì Angir om hemmeligheten skal tilbaketrekkes selv n√•r den ikke er i bruk.</p>
                    <p><strong>singlePageApplication</strong> _(bool, optional)_ ‚Äì Angir om denne Entra ID-applikasjonen skal registreres som en single-page-application for bruk i klient-side-applikasjoner uten tilgang til hemmeligheter.</p>
                </details>

                ### Eksempel

                F√∏lgende eksempel er et YAML-manifest som oppretter app-registreringen `atgcp1-sandbox:tilgangsstyring-main:test-app`.
                Den gir kun tilgang til direkte medlemmer av gruppene med objekt-ID `2720e397-081d-4d9b-852e-0d81f45a304f` eller `c3c94454-aefc-44f9-9076-58ea47547941`.
                Den forh√•ndsautoriserer ogs√• Entra ID klienten `atgcp1-dev:other-namespace:other-app`.
                N√•r registrering er fullf√∏rt vil Azurerator automatisk opprette Kubernetes-hemmeligheten `entraid-secret` i namespacet `tilgangsstyring-main`.

```yaml
apiVersion: nais.io/v1
kind: AzureAdApplication
metadata:
  name: test-app
  namespace: tilgangsstyring-main
spec:
  allowAllUsers: false
  claims:
    groups:
      - id: 2720e397-081d-4d9b-852e-0d81f45a304f
      - id: c3c94454-aefc-44f9-9076-58ea47547941
  replyUrls:
    - url: https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/callback
  preAuthorizedApplications:
    - application: other-app
      namespace: other-namespace
      cluster: atgcp1-dev
```

            </TabItem>
            <TabItem value="idportenclient" label="IdportenClient">
                ## üöß Under arbeid üöß

                Dette innholdet er under arbeid og forh√•pentligvis straks klart!
            </TabItem>
            <TabItem value="maskinportenclient" label="MaskinportenClient">
                ## üöß Under arbeid üöß

                Dette innholdet er under arbeid og forh√•pentligvis straks klart!
            </TabItem>
        </Tabs>
    </TabItem>
</Tabs>